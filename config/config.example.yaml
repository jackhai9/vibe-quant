# vibe-quant 配置文件示例
# 复制此文件为 config.yaml 并根据需要修改

global:
  testnet: false
  proxy: null   # 代理设置，如 "http://127.0.0.1:7890"，不使用则设为 null
  ws:
    stale_data_ms: 1500
    reconnect:
      initial_delay_ms: 1000
      max_delay_ms: 30000
      multiplier: 2
  # 限速
  rate_limit:
    max_orders_per_sec: 5
    max_cancels_per_sec: 8
  # Telegram
  # 凭证需配置到.env中：TELEGRAM_BOT_TOKEN / TELEGRAM_CHAT_ID
  telegram:
    enabled: false
    events:
      on_fill: true
      on_reconnect: true
      on_risk_trigger: true
      on_open_alert: true

  execution:
    order_ttl_ms: 4000
    repost_cooldown_ms: 100
    min_signal_interval_ms: 200
    base_lot_mult: 1

    # maker 定价策略
    # at_touch: 挂在对手价
    # inside_spread_1tick: 挂在对手价内缩 1 tick
    # custom_ticks: 挂在对手价内缩 n tick
    maker_price_mode: "inside_spread_1tick"
    maker_n_ticks: 1
    # post-only maker 安全距离（ticks），越大越不容易 -5022，但更难成交
    maker_safety_ticks: 1

    # 双保险
    max_mult: 100               # 最大加速倍数  final_mult = base_mult * roi_mult * accel_mult，不超过此值
    max_order_notional: 500     # 最大单笔订单名义价值（USDT）

    # 模式轮转（MAKER_ONLY ↔ AGGRESSIVE_LIMIT）
    maker_timeouts_to_escalate: 2
    aggr_fills_to_deescalate: 1
    aggr_timeouts_to_deescalate: 2

  # 加速倍数
  accel:
    window_ms: 2000       # 2秒窗口
    tiers:                # LONG/SHORT 共用，方向自动处理
      - { ret: 0.001, mult: 2 }    # 窗口涨/跌幅 >= 0.1% 时，mult=2
      - { ret: 0.002, mult: 3 }    # 窗口涨/跌幅 >= 0.2% 时，mult=3
      - { ret: 0.005, mult: 5 }    # 窗口涨/跌幅 >= 0.5% 时，mult=5
      - { ret: 0.01, mult: 10 }    # 窗口涨/跌幅 >= 1.0% 时，mult=10

  # ROI 倍数
  roi:
    tiers:
      - { roi: 0.1, mult: 2 }     # ROI >= 10% 时，mult=2
      - { roi: 0.2, mult: 3 }     # ROI >= 20% 时，mult=3
      - { roi: 0.5, mult: 5 }     # ROI >= 50% 时，mult=5

  # 风控
  risk:
    # 风控等级映射（用于日志展示，可按需调整）
    # - key 是“风险阶段/类型”，value 是等级数字
    # - 例如：想在 2 和 3 之间插入新等级，只需要改这里，不需要改代码里的 log_event
    levels:
      liq_distance_breach: 1
      panic_close: 2
      protective_stop: 3

    # 第一等级：满足触发条件的情况下，距离强平价多少比例时开始 切换到 AGGRESSIVE_LIMIT 模式（更激进的平仓）
    # liq_distance_threshold = abs(mark_price - liquidation_price) / mark_price
    liq_distance_threshold: 0.05

    # 第二等级：不管是否满足触发条件，距离强平价多少比例时开始 按梯度平仓
    # 平仓时先尝试限价，如果超时未成交则使用 AGGRESSIVE_LIMIT
    panic_close:
      enabled: true
      ttl_percent: 0.5
      tiers:
        - { dist_to_liq: 0.04, slice_ratio: 0.02, maker_timeouts_to_escalate: 2 }
        - { dist_to_liq: 0.03, slice_ratio: 0.05, maker_timeouts_to_escalate: 2 }
        - { dist_to_liq: 0.02, slice_ratio: 0.10, maker_timeouts_to_escalate: 2 }

    # 第三等级：仓位保护性止损（交易所端条件单，防程序崩溃/休眠/断网/意外事件等）
    # - 使用 STOP_MARKET + closePosition
    # - workingType=MARK_PRICE（按标记价格触发）
    protective_stop:
      enabled: true
      dist_to_liq: 0.01
      # 外部止损接管：当检测到外部 stop/tp（cp=True 或 reduceOnly=True）时，本程序停止维护自己的保护止损；并定期用 REST 校验释放锁存（REST 以 raw openOrders 为主）
      external_takeover:
        enabled: true
        rest_verify_interval_s: 30
        max_hold_s: 300

# Symbol 配置（可覆盖 global 中的 execution/accel/roi/risk）
symbols:
  # 示例：BTC 永续
  # BTC/USDT:USDT:
  #   execution:
  #     order_ttl_ms: 3000
  #     max_order_notional: 1000

  # 示例：ETH 永续
  # ETH/USDT:USDT:
  #   execution:
  #     max_order_notional: 500
